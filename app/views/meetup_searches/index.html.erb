<div class="index">    
    <div class="container border m-3">
        <h1>Meetups near you</h1>
    </div>    
    <div id="map" class="container border m-3">
        <p>Map placeholder</p>
    </div> 
    <div class="container border m-3">
        <p>
            <% @nearby_meetup_locations.each do |meetup_location|%>
                <p>
                <%=form_with(model: @meetup_user, method: :post, local: true) do |form|%>
                    <%=meetup_location.place_name%> 
                    at <%=meetup_location.place_address%>
                    at <%=meetup_location.date_time.strftime("%B %d, %Y (%A) at %l:%M %P")%>
                    by <%meetup_location.users.each do |user|%>
                            <%=user.first_name%>
                            <%=user.profession%>
                    <% end %>
                    <%= form.hidden_field :meetup_location, :value => "#{meetup_location.id}" %>
                    <%=form.submit "Join!", class: "btn btn-secondary"%>
                <% end %>
                </p>
            <% end %>
        </p>
    </div>
</div>
<script defer >
    function initMap() {
        var vancouver = {lat: location.lat, lng: location.lng};
        var map = new google.maps.Map(
            document.getElementById('map'), {zoom: 12, center: vancouver}
        );
        navigator.geolocation.getCurrentPosition((position) => {
            var location = {lat: position.coords.latitude, lng: position.coords.longitude}
            map.setCenter(location)
            var marker = new google.maps.Marker({position: location, map: map});
        })
        setMarkers(map);
    }

    function setMarkers(map) {
      <% @nearby_meetup_locations.each do |location| %>
        var infowindow = new google.maps.InfoWindow({
          content: '<h2><%= location.place_name %></h2>'
        });  
        marker = new google.maps.Marker({
            position: {lat: <%= location.latitude %>, lng: <%= location.longitude%>},
            map: map
          });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
      <% end %>
    }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=YourAPIKey&callback=initMap"
  type="text/javascript">
</script>