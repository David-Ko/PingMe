<div class="index">    
    <div class="container border m-3">
        <h1>Meetups near you</h1>
    </div>    
    <div id="map" class="container border m-3">
        <p>Map placeholder</p>
    </div> 
    <div class="container border m-3">
        <p>
            <% @nearby_meetup_locations.each do |meetup_location|%>
                <p>
                <% if meetup_location.users.count < 2 %>
                    <%=form_with(model: @meetup_user, method: :post, local: true) do |form|%>
                        <%=meetup_location.place_name%> 
                        at <%=meetup_location.place_address%>
                        at <%=meetup_location.date_time.strftime("%B %d, %Y (%A) at %l:%M %P")%>
                        by <%meetup_location.users.each do |user|%>
                                <%=user.first_name%>
                                <%=user.profession%>
                        <% end %>
                        <%= form.hidden_field :meetup_location, :value => "#{meetup_location.id}" %>
                        <%=form.submit "Join!", class: "btn btn-secondary"%>
                    <% end %>
                <% end %>
                </p>
            <% end %>
        </p>
    </div>
</div>
<script defer >
    function initMap() {
        var vancouver = {lat:49.2827, lng:-123.1207};
        var map = new google.maps.Map(
            document.getElementById('map'), {zoom: 12, center: vancouver}
        );
        var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        navigator.geolocation.getCurrentPosition((position) => {
            var location = {lat: position.coords.latitude, lng: position.coords.longitude}
            map.setCenter(location)
            var marker = new google.maps.Marker({position: location, map: map, icon: image});
            var infowindow = new google.maps.InfoWindow({
                content: '<h2>You are here!</h2>'
            });
            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });
        })
        setMarkers(map);
    }
    function setMarkers(map) {
      <% @nearby_meetup_locations.each do |location| %>
        {
        const infowindow = new google.maps.InfoWindow({
          content: '<h2><%= location.place_name %></h2>'
        });  
        const marker = new google.maps.Marker({
            position: {lat: <%= location.latitude %>, lng: <%= location.longitude%>},
            map: map
          });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
        }
      <% end %>
    }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=YourAPIKey&callback=initMap"
  type="text/javascript">
</script>