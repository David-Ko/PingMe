<div class="index">    
    <div class="container border m-3">
        <h3>Meetups near you</h3>
    </div>    
    <div id="map" class="container border m-3">
        <p>Map placeholder</p>
    </div> 
    <div class="container border m-3">
        <p>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Venue</th>
                        <th scope="col">Address</th>
                        <th scope="col">Date</th>
                        <th scope="col">Host</th>
                        <th scope="col">Occupation</th>
                        <th scope="col">Join?</th>
                    </tr>
                </thead>
                <tbody>
                    <% @nearby_meetup_locations.each do |meetup_location|%>
                        <p>
                            <% if meetup_location.users.count < 2 %>
                                <%=form_with(model: @meetup_user, method: :post, local: true) do |form|%>
                                    <tr>
                                        <th scope="row"><%=meetup_location.place_name%></th>
                                        <td><%=meetup_location.place_address%></td>
                                        <td><%=meetup_location.date_time.strftime("%B %d, %Y (%A) at %l:%M %P")%></td>
                                        <td><%=meetup_location.users.first.first_name%></td>
                                        <td><%=meetup_location.users.first.profession%></td>
                                        <%= form.hidden_field :meetup_location, :value => "#{meetup_location.id}" %>
                                        <td><%=form.submit "Yes!", class: "btn btn-secondary"%></td>
                                    </tr>
                                <% end %>
                            <% end %>
                        </p>
                    <% end %>
                </tbody>
            </table>    
        </p>
    </div>
</div>
<script defer >
    function initMap() {
        var vancouver = {lat:49.2827, lng:-123.1207};
        var map = new google.maps.Map(
            document.getElementById('map'), {zoom: 12, center: vancouver}
        );
        var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
        navigator.geolocation.getCurrentPosition((position) => {
            var location = {lat: position.coords.latitude, lng: position.coords.longitude}
            map.setCenter(location)
            var marker = new google.maps.Marker({position: location, map: map, icon: image});
            var infowindow = new google.maps.InfoWindow({
                content: '<h2>You are here!</h2>'
            });
            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });
        })
        setMarkers(map);
    }
    function setMarkers(map) {
      
      <% @nearby_meetup_locations.each do |location| %>
        {
        <% if location.users.count < 2 %>
        const infowindow = new google.maps.InfoWindow({
          content: '<h2><%= location.place_name %></h2>'
        });  
        const marker = new google.maps.Marker({
            position: {lat: <%= location.latitude %>, lng: <%= location.longitude%>},
            map: map
          });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
        <% end %>
        }
      <% end %>

    }
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=YourAPIKey&callback=initMap"
  type="text/javascript">
</script>